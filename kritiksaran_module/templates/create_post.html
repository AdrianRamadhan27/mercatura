{% extends 'base.html' %}
{% load static %}

{% block content %}
<html>

<head>
</head>
<style>
    body {
        font-family: 'Poppins';
        background-image: linear-gradient(to right, #ECE8FF, #E0FFF7);
    }
</style>

<body>

    <div class="flex flex-col container mx-auto px-6 pt-28 space-y-4">
        <div>
            <h1 style="color: #5E239D;  font-weight: 500; font-size: 300%;" class="pb-1.5">
                Kritik dan Saran </h1>
            <input type="button" id="submit" value="Sudah ada berapa kritik dan saran?"
                class="bg-[#5E239D] text-white p-2 rounded-lg hover:bg-[#5E239D]/80 drop-shadow-xl">
        </div>

        <div>

            <div class="flex flex-col space-y-6">
                {% if user.is_authenticated %}
                <div>
                    <form method="POST" id="post-form" class="space-y-4">
                        {% csrf_token %}
                        <p class="font-semibold">Judul</p>
                        <div class="form-group">
                            {{ form.title }}
                        </div>
                        <p class="font-semibold">Deskripsi</p>
                        <div class="form-group">
                            {{ form.description }}
                        </div>
                        <button type="submit"
                            class="bg-[#5E239D] text-white py-2 px-3 rounded-lg hover:bg-[#5E239D]/80 drop-shadow-xl">Submit</button>
                    </form>
                    {% else %}
                    <div class="pb-2 animate-pulse">
                        <h2 style="color:#F61067;text-align:left;user-select: none;font-weight: 500;" class="text-xl text-white bg-red-500 p-2 rounded-lg w-1/2">Login untuk menambahkan
                            kritik dan
                            saran!</h2>
                    </div>
                    
                    {% endif %}
                </div>


                <div class="posts">
                    {% for post in posts %}
                    <div class="">
                        <div
                            class="pb-3">
                            <div class="flex flex-col p-4 space-y-2 rounded-2xl" style="background-color: #E2DBFD">
                                <h3 style="color: #150433;" class="text-xl">{{post.title}}</h3>
                                <h5 class="mb-auto" style="color: #5A5A5A; font-weight: lighter;">{{post.description}}
                                </h5>
                                <div class="flex space-x-2">
                                    <div class="pt-1">
                                        <p class="mb-auto" style="color: #5E239D;"> <svg xmlns="http://www.w3.org/2000/svg"
                                            width="16" height="16" fill="currentColor" class="bi bi-person-circle"
                                            viewBox="0 0 16 16" style="color: #5E239D;">
                                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                                            <path fill-rule="evenodd"
                                                d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
                                        </svg> </p>
                                    </div>
                                    <div class="my-auto text-[#5E239D]">
                                        {{post.user.username}}
                                    </div>
                                </div>

                                <hr>

                                <div class="right floated">
                                    {% if user.is_authenticated %}
                                    <form action="{% url 'kritiksaran_module:setuju-post-view' %}" method="POST"
                                        class='setuju-form space-y-1' id='{{post.id}}'>
                                        {% csrf_token %}
                                        <input type="hidden" name="post_id" value={{post.id}}>

                                        <button type="submit"
                                        class="bg-[#00F0B5] text-black border-[1px] border-black py-1.5 px-3 rounded-lg hover:bg-[#00F0B5]/90 drop-shadow-xl text-sm">
                                            Setuju
                                        </button>
                       
                                        {% else %}
                                        <h5
                                            style="color:#5E239D;text-align:left;user-select: none;font-weight: 200;color: #F61067;">
                                            Login untuk setuju dengan kritik dan saran!</h5>
                                        {% endif %}
                                        <div class="ui grid">
                                            <div class="column">
                                                <div class="setuju-count{{post.id}} text-base"> {{post.num_setuju}} pengguna
                                                    setuju</div>
                                            </div>

                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
            </div>

        </div>
    </div>


</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>


    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (settings.type == 'POST' || settings.type == 'PUT' || settings.type == 'DELETE') {
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        }
    });


    $(document).on('submit', '#post-form', function (e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',

            url: '{% url "kritiksaran_module:create_post" %}',
            data: {
                username: $('#username').val(),
                title: $('#title').val(),
                id: $('#id').val(),
                setuju: $('setuju').val(),
                num_setuju: $('#total-setuju').val(),
                contact: $('#contact').val(),
                description: $('#description').val(),
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                action: 'post'
            },
            success: function (json) {
                document.getElementById("post-form").reset();
                const url = '{% url "kritiksaran_module:setuju-post-view" %}'

                $(".posts").append('<div class = "">' +
                    '<div class="flex flex-col p-4 space-y-2 rounded-2xl" style="background-color: #E2DBFD">' +
                    '<h3 class="mb-0" style="color: #150433; font-size: larger">' + json.title + '</h3>' +
                    '<h5 class="mb-auto" style="color: #5A5A5A; font-weight: lighter;">' + json.description + '</h5>' +

'<div class="flex space-x-2">' +

                   '<div class="pt-1">' +
                                        '<p class="mb-auto" style="color: #5E239D;"> <svg xmlns="http://www.w3.org/2000/svg"'+
                                            'width="16" height="16" fill="currentColor" class="bi bi-person-circle" '+
                                            'viewBox="0 0 16 16" style="color: #5E239D;"> '+
                                            '<path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" /> '+
                                            '<path fill-rule="evenodd" '+
                                            'd="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" /> '+
                                                '</svg> </p> '+
                                        '</div> '+
                                    '<div class="my-auto text-[#5E239D]"> '+
                                        json.username + '</div> '+ '</div> ' +

                    '<hr>' +
                    '<div class="right floated">' +
                    '<form action="' + url + '" method="POST" class="setuju-form" id="' + json.id + '">' +
                    '{% csrf_token %}' +
                    '<input type="hidden" name="post_id" value=' + json.id + '>' +
                    
                    '<button type="submit" class="ui button setuju-btn{{' + json.id + '}} btn btn-dark btn-rounded" style="background-color: #00F0B5; color: black;">' +
                    'Setuju' +
                    '</button>' +
                    '<div class="ui grid">' +
                    '<div class="column">' +
                    '<div class="setuju-count{{' + json.id + '}}">' + json.setuju + ' pengguna setuju</div>' +
                    '</div>' +
                    '</div>' +
                    '</form>' +
                    '</div>' +

                    '</div>' +
                    '</div>'
                )
            },
            error: function (xhr, errmsg, err) {
                $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: " + errmsg +
                    " <a href='#' class='close'>&times;</a></div>");
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });

    });


    $(document).ready(function () {
        $('.setuju-form').submit(function (e) {
            e.preventDefault()

            const post_id = $(this).attr('id')

            const likeText = $(`.setuju-btn${post_id}`).text()
            const trim = $.trim(likeText)

            const url = $(this).attr('action')

            let res;
            const setujus = $(`.setuju-count${post_id}`).text()
            const trimCount = parseInt(setujus)

            $.ajax({
                type: 'POST',
                url: '{% url "kritiksaran_module:setuju-post-view" %}',
                data: {
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').text(),
                    'post_id': post_id,
                },
                success: function (response) {
                    res = trimCount + 1
                    $(`.setuju-count${post_id}`).text(res + " pengguna setuju")
                },

            });

        });

    });


    $(document).ready(function () {
        $("#submit").click(function () {
            $.ajax({
                type: 'GET',
                url: '{% url "kritiksaran_module:total_number" %}',
                success: function (data) {
                    alert("Terdapat sebanyak " + data + " kritik dan saran");
                }
            });
            return false;
        });
    });


</script>




</html>
{% endblock content %}